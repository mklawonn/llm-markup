<!DOCTYPE html>
<meta charset="utf-8">
<title>LLM Policy Mutation Validation</title>
<link rel="help" href="https://example.org/web-agent-markup#token-based-enforcement">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="../../resources/web-agent-markup-helpers.js"></script>

<div id="test-container"></div>

<script>
'use strict';

// =============================================================================
// checkMutationPermission Method
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'readonly' });
  const violation = el.checkMutationPermission('style');
  assert_not_equals(violation, null, 'Should return violation object');
  assert_equals(violation.violationType, 'permission-denied');
  assert_equals(violation.deniedPermission, 'style');
}, 'checkMutationPermission returns violation for denied permission');

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'style' });
  const violation = el.checkMutationPermission('style');
  assert_equals(violation, null, 'Should return null for allowed permission');
}, 'checkMutationPermission returns null for allowed permission');

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'mutable' });
  for (const token of VALID_OUTPUT_TOKENS) {
    if (token !== 'readonly') {
      const violation = el.checkMutationPermission(token);
      assert_equals(violation, null, `'${token}' should be allowed with mutable`);
    }
  }
}, 'mutable allows all mutation types');

// =============================================================================
// Style Token Enforcement
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'style' });
  assert_equals(el.checkMutationPermission('style'), null);
  assert_not_equals(el.checkMutationPermission('content'), null);
  assert_not_equals(el.checkMutationPermission('data'), null);
}, "'style' token allows style, blocks content and data");

test(() => {
  const el = createLLMElement('div', {
    'wam-policy-output': 'style',
    'class': 'original'
  });
  // Simulate checking if class attribute can be modified
  const violation = el.checkMutationPermission('style');
  assert_equals(violation, null, 'Class modification should be allowed');
}, "'style' token allows class attribute modification");

// =============================================================================
// Content Token Enforcement
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'content' });
  assert_equals(el.checkMutationPermission('content'), null);
  assert_not_equals(el.checkMutationPermission('style'), null);
  assert_not_equals(el.checkMutationPermission('append'), null);
}, "'content' token allows text modification only");

// =============================================================================
// Annotation Token Enforcement
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'annotation' });
  assert_equals(el.checkMutationPermission('annotation'), null);
  assert_not_equals(el.checkMutationPermission('content'), null);
}, "'annotation' token allows wrapping but not text modification");

// =============================================================================
// Layout Token Enforcement
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'layout' });
  assert_equals(el.checkMutationPermission('layout'), null);
  assert_not_equals(el.checkMutationPermission('content'), null);
  assert_not_equals(el.checkMutationPermission('append'), null);
}, "'layout' token allows reordering only");

// =============================================================================
// Data Token Enforcement
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'data' });
  assert_equals(el.checkMutationPermission('data'), null);
  assert_not_equals(el.checkMutationPermission('content'), null);
}, "'data' token allows data attributes but not text content");

// =============================================================================
// Append Token Enforcement
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'append' });
  assert_equals(el.checkMutationPermission('append'), null);
  assert_not_equals(el.checkMutationPermission('content'), null);
  assert_not_equals(el.checkMutationPermission('layout'), null);
}, "'append' token allows adding children only");

// =============================================================================
// Interaction Token Enforcement
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'interaction' });
  assert_equals(el.checkMutationPermission('interaction'), null);
  assert_not_equals(el.checkMutationPermission('content'), null);
}, "'interaction' token allows behavioral layer modifications");

// =============================================================================
// Readonly Enforcement
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'readonly' });
  for (const token of VALID_OUTPUT_TOKENS) {
    if (token !== 'readonly') {
      const violation = el.checkMutationPermission(token);
      assert_not_equals(violation, null, `'${token}' should be blocked with readonly`);
    }
  }
}, "'readonly' blocks all mutation types");

// =============================================================================
// Combined Tokens
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'style annotation' });
  assert_equals(el.checkMutationPermission('style'), null);
  assert_equals(el.checkMutationPermission('annotation'), null);
  assert_not_equals(el.checkMutationPermission('content'), null);
}, 'Combined tokens grant union of permissions');

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'content data append' });
  assert_equals(el.checkMutationPermission('content'), null);
  assert_equals(el.checkMutationPermission('data'), null);
  assert_equals(el.checkMutationPermission('append'), null);
  assert_not_equals(el.checkMutationPermission('style'), null);
}, 'Multiple tokens grant all specified permissions');

// =============================================================================
// Violation Object Properties
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'readonly' });
  const violation = el.checkMutationPermission('content');

  assert_true('target' in violation);
  assert_true('violationType' in violation);
  assert_true('deniedPermission' in violation);
  assert_true('message' in violation);
  assert_true('timestamp' in violation);
}, 'Violation object has required properties');

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'readonly' });
  const violation = el.checkMutationPermission('content');

  assert_equals(violation.target, el);
  assert_equals(violation.deniedPermission, 'content');
  assert_true(typeof violation.message === 'string');
  assert_true(typeof violation.timestamp === 'number');
}, 'Violation object properties have correct values');

test(() => {
  const el = createLLMElement('div', { 'wam-policy-output': 'readonly' });
  const violation = el.checkMutationPermission('content');
  const json = violation.toJSON();

  assert_true(typeof json === 'object');
  assert_true('violationType' in json);
  assert_true('deniedPermission' in json);
}, 'Violation object can be serialized to JSON');

// =============================================================================
// Semantic Payload Principle
// =============================================================================

test(() => {
  const el = createLLMElement('a', {
    'wam-policy-output': 'content',
    'href': 'https://example.com'
  });
  // Even with 'content' permission, 'href' should be immutable
  // This tests the Semantic Payload Principle
  const violation = el.checkMutationPermission('data');
  assert_not_equals(violation, null, 'href is protected by Semantic Payload Principle');
}, 'Semantic payload attributes are protected even with content permission');

test(() => {
  const el = createLLMElement('img', {
    'wam-policy-output': 'style content',
    'src': 'image.png'
  });
  // 'src' is a payload attribute, should require 'mutable'
  // Test that style+content doesn't allow src modification
  assert_false(el.wamPolicy.hasOutputPermission('mutable'));
}, 'src attribute requires mutable permission');

test(() => {
  const el = createLLMElement('form', {
    'wam-policy-output': 'data',
    'action': '/submit'
  });
  // 'action' is a payload attribute per Semantic Payload Principle
  // Even 'data' token shouldn't allow modifying it
  assert_false(el.wamPolicy.isMutable);
}, 'action attribute is protected as semantic payload');

// =============================================================================
// License Intersection with Output
// =============================================================================

test(() => {
  const el = createLLMElement('div', {
    'wam-policy-license': 'CC-BY-ND',
    'wam-policy-output': 'content'
  });
  // CC-BY-ND should block content modification
  const violation = el.checkMutationPermission('content');
  assert_not_equals(violation, null);
  assert_equals(violation.violationType, 'license-violation');
}, 'License profile blocks conflicting output permission');
</script>
