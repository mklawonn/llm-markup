<!DOCTYPE html>
<meta charset="utf-8">
<title>LLM Intent Prompt Construction</title>
<link rel="help" href="https://example.org/llm-markup#intent-processing-model">
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="../../resources/llm-markup-helpers.js"></script>

<div id="test-container"></div>

<script>
'use strict';

// =============================================================================
// Hierarchy of Instruction: llm-intent-instruction (Highest Priority)
// =============================================================================

test(() => {
  const el = createLLMElement('div', {
    'llm-intent-instruction': 'Custom instruction for this element.'
  });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, 'Custom instruction for this element.');
}, 'llm-intent-instruction is used directly as the prompt');

test(() => {
  const el = createLLMElement('div', {
    'llm-intent-category': 'quote',
    'llm-intent-instruction': 'Override instruction'
  });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, 'Override instruction');
}, 'llm-intent-instruction overrides category');

test(() => {
  const el = createLLMElement('div', {
    'llm-intent-category': 'summary',
    'llm-intent-tone': 'formal',
    'llm-intent-instruction': 'Use this exact instruction'
  });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, 'Use this exact instruction');
}, 'llm-intent-instruction overrides all other intent attributes');

// =============================================================================
// Hierarchy of Instruction: Standardized Lexicon
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'llm-intent-category': 'summary' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, LEXICON_CATEGORIES['summary']);
}, "Lexicon category 'summary' generates optimized prompt");

test(() => {
  const el = createLLMElement('div', { 'llm-intent-category': 'definition' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, LEXICON_CATEGORIES['definition']);
}, "Lexicon category 'definition' generates optimized prompt");

test(() => {
  const el = createLLMElement('div', { 'llm-intent-category': 'code-block' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, LEXICON_CATEGORIES['code-block']);
}, "Lexicon category 'code-block' generates optimized prompt");

test(() => {
  const el = createLLMElement('div', { 'llm-intent-category': 'legal-disclaimer' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, LEXICON_CATEGORIES['legal-disclaimer']);
}, "Lexicon category 'legal-disclaimer' generates optimized prompt");

test(() => {
  const el = createLLMElement('div', { 'llm-intent-category': 'satire' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, LEXICON_CATEGORIES['satire']);
}, "Lexicon category 'satire' generates optimized prompt");

// Test all lexicon categories
for (const [category, expectedPrompt] of Object.entries(LEXICON_CATEGORIES)) {
  test(() => {
    const el = createLLMElement('div', { 'llm-intent-category': category });
    const prompt = el.llmIntent.generatePrompt();
    assert_equals(prompt, expectedPrompt);
  }, `Lexicon category '${category}' generates correct optimized prompt`);
}

// =============================================================================
// Hierarchy of Instruction: Fallback Templates
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'llm-intent-category': 'custom-category' });
  const prompt = el.llmIntent.generatePrompt();
  const expected = FALLBACK_TEMPLATES.category.replace('[value]', 'custom-category');
  assert_equals(prompt, expected);
}, 'Custom category uses fallback template');

test(() => {
  const el = createLLMElement('button', { 'llm-intent-function': 'custom-action' });
  const prompt = el.llmIntent.generatePrompt();
  const expected = FALLBACK_TEMPLATES.function.replace('[value]', 'custom-action');
  assert_equals(prompt, expected);
}, 'Custom function uses fallback template');

test(() => {
  const el = createLLMElement('div', { 'llm-intent-workflow': 'custom-stage' });
  const prompt = el.llmIntent.generatePrompt();
  const expected = FALLBACK_TEMPLATES.workflow.replace('[value]', 'custom-stage');
  assert_equals(prompt, expected);
}, 'Custom workflow uses fallback template');

test(() => {
  const el = createLLMElement('div', { 'llm-intent-output': 'custom-format' });
  const prompt = el.llmIntent.generatePrompt();
  const expected = FALLBACK_TEMPLATES.output.replace('[value]', 'custom-format');
  assert_equals(prompt, expected);
}, 'Custom output format uses fallback template');

test(() => {
  const el = createLLMElement('div', { 'llm-intent-tone': 'custom-tone' });
  const prompt = el.llmIntent.generatePrompt();
  const expected = FALLBACK_TEMPLATES.tone.replace('[value]', 'custom-tone');
  assert_equals(prompt, expected);
}, 'Custom tone uses fallback template');

// =============================================================================
// Entity & Importance (Independent Layers)
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'llm-intent-importance': 'critical' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, IMPORTANCE_PROMPTS['critical']);
}, "'critical' importance generates correct prompt");

test(() => {
  const el = createLLMElement('div', { 'llm-intent-importance': 'high' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, IMPORTANCE_PROMPTS['high']);
}, "'high' importance generates correct prompt");

test(() => {
  const el = createLLMElement('div', { 'llm-intent-importance': 'normal' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, IMPORTANCE_PROMPTS['normal']);
}, "'normal' importance generates empty prompt");

test(() => {
  const el = createLLMElement('div', { 'llm-intent-importance': 'low' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, IMPORTANCE_PROMPTS['low']);
}, "'low' importance generates correct prompt");

test(() => {
  const el = createLLMElement('div', { 'llm-intent-importance': 'background' });
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, IMPORTANCE_PROMPTS['background']);
}, "'background' importance generates correct prompt");

// =============================================================================
// getLexiconPrompt Method
// =============================================================================

test(() => {
  const el = createLLMElement('div', {});
  const prompt = el.llmIntent.getLexiconPrompt('summary');
  assert_equals(prompt, LEXICON_CATEGORIES['summary']);
}, 'getLexiconPrompt returns optimized prompt for valid term');

test(() => {
  const el = createLLMElement('div', {});
  const prompt = el.llmIntent.getLexiconPrompt('invalid-term');
  assert_equals(prompt, null);
}, 'getLexiconPrompt returns null for unknown term');

test(() => {
  const el = createLLMElement('div', {});
  const prompt = el.llmIntent.getLexiconPrompt('');
  assert_equals(prompt, null);
}, 'getLexiconPrompt returns null for empty string');

// =============================================================================
// Combined Prompt Generation
// =============================================================================

test(() => {
  const el = createLLMElement('div', {
    'llm-intent-category': 'quote',
    'llm-intent-importance': 'high'
  });
  const prompt = el.llmIntent.generatePrompt();
  // Should include both category prompt and importance prompt
  assert_true(prompt.includes(LEXICON_CATEGORIES['quote']) ||
              prompt.includes(IMPORTANCE_PROMPTS['high']));
}, 'Combined category and importance generates composite prompt');

test(() => {
  const el = createLLMElement('div', {
    'llm-intent-category': 'code-block',
    'llm-intent-tone': 'formal'
  });
  const prompt = el.llmIntent.generatePrompt();
  // Should include category prompt (lexicon takes precedence over tone template)
  assert_true(prompt.includes(LEXICON_CATEGORIES['code-block']) ||
              prompt.includes('formal'));
}, 'Category with tone generates appropriate prompt');

// =============================================================================
// Entity Reference
// =============================================================================

test(() => {
  const el = createLLMElement('span', {
    'llm-intent-entity': 'https://www.wikidata.org/wiki/Q42'
  });
  el.textContent = 'Douglas Adams';
  const prompt = el.llmIntent.generatePrompt();
  // Entity should be appended as reference anchor
  assert_true(prompt.includes('https://www.wikidata.org/wiki/Q42') ||
              prompt.includes('Entity Reference'));
}, 'Entity URI is included in prompt generation');

// =============================================================================
// No Intent Attributes
// =============================================================================

test(() => {
  const el = createLLMElement('div', {});
  const prompt = el.llmIntent.generatePrompt();
  assert_equals(prompt, '');
}, 'Element with no intent attributes generates empty prompt');

// =============================================================================
// Whitespace Handling
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'llm-intent-category': '  quote  ' });
  const prompt = el.llmIntent.generatePrompt();
  // Should normalize whitespace
  assert_true(prompt.length > 0);
}, 'Category with extra whitespace is normalized');

// =============================================================================
// Case Sensitivity
// =============================================================================

test(() => {
  const el = createLLMElement('div', { 'llm-intent-category': 'SUMMARY' });
  // Lexicon lookup should be case-insensitive
  const isLexicon = el.llmIntent.isLexiconCategory();
  assert_true(isLexicon);
}, 'Lexicon lookup is case-insensitive');
</script>
