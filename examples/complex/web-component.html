<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web Agent Markup: Web Components and Shadow DOM Example</title>
  <meta name="description" content="Demonstrates Shadow DOM policy boundaries and component isolation">
</head>
<body>

<h1>Web Components with Shadow DOM Policy Boundaries</h1>

<!--
  Page-level policy: Allow content modification by default.
  Components will decide whether to inherit this.
-->
<main wam-policy-output="content annotation">

  <p>
    This page demonstrates how Shadow DOM creates policy boundaries.
    Components can opt-in to inherit page policies or maintain isolation.
  </p>

  <!--
    ISOLATED COMPONENT (Default Behavior)
    The component does NOT inherit page policies.
  -->
  <h2>Isolated Component (Default)</h2>
  <isolated-card>
    <!-- Content passed to slot -->
    <span slot="title">User Dashboard</span>
    <p slot="content">Your account balance: $1,234.56</p>
  </isolated-card>

  <!--
    INHERITING COMPONENT
    The component opts-in to inherit page policies.
  -->
  <h2>Inheriting Component</h2>
  <inheriting-card>
    <span slot="title">Public Profile</span>
    <p slot="content">This content can be modified by the LLM.</p>
  </inheriting-card>

  <!--
    SELECTIVE INHERITANCE
    Component inherits only specific namespaces.
  -->
  <h2>Selective Inheritance (Input Only)</h2>
  <selective-card>
    <span slot="title">Semi-Protected</span>
    <p slot="content">LLM can see this but not modify it.</p>
  </selective-card>

</main>

<script>
// =============================================================================
// ISOLATED COMPONENT
// Shadow root with default settings (no inheritance)
// =============================================================================
class IsolatedCard extends HTMLElement {
  constructor() {
    super();

    // Default: wamPolicyInherit = false
    // Shadow root is a policy boundary
    const shadow = this.attachShadow({
      mode: 'open',
      wamPolicyInherit: false,  // Default - explicit for clarity
      wamProvenanceTransparent: false
    });

    shadow.innerHTML = `
      <style>
        :host {
          display: block;
          border: 2px solid #e74c3c;
          border-radius: 8px;
          padding: 16px;
          margin: 16px 0;
        }
        .header { font-weight: bold; color: #e74c3c; }
        .badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
      </style>

      <div class="header">
        <slot name="title"></slot>
        <span class="badge">Isolated</span>
      </div>

      <!--
        This content uses component's own policies, NOT page policies.
        Default spec behavior: readonly, ephemeral.
      -->
      <div class="body" wam-policy-output="readonly" wam-policy-memory="none">
        <slot name="content"></slot>
        <p><em>Internal component state is protected.</em></p>
      </div>

      <!--
        Component's internal secret - completely hidden even if page
        tries to set wam-policy-input="all"
      -->
      <div class="internal" wam-policy-input="none">
        <p>Component internal: API_KEY=secret123</p>
      </div>
    `;
  }
}
customElements.define('isolated-card', IsolatedCard);

// =============================================================================
// INHERITING COMPONENT
// Shadow root that opts-in to inherit all policies
// =============================================================================
class InheritingCard extends HTMLElement {
  constructor() {
    super();

    // Opt-in to inherit all policy namespaces
    const shadow = this.attachShadow({
      mode: 'open',
      wamPolicyInherit: true,  // Inherit input, output, and memory
      wamProvenanceTransparent: true  // Full provenance details to document ledger
    });

    shadow.innerHTML = `
      <style>
        :host {
          display: block;
          border: 2px solid #27ae60;
          border-radius: 8px;
          padding: 16px;
          margin: 16px 0;
        }
        .header { font-weight: bold; color: #27ae60; }
        .badge { background: #27ae60; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
      </style>

      <div class="header">
        <slot name="title"></slot>
        <span class="badge">Inheriting</span>
      </div>

      <!--
        This content inherits page policies (content annotation).
        Effective policy = intersection of inherited + local.
      -->
      <div class="body">
        <slot name="content"></slot>
        <p>Component content can be modified if page allows.</p>
      </div>
    `;
  }
}
customElements.define('inheriting-card', InheritingCard);

// =============================================================================
// SELECTIVE INHERITANCE COMPONENT
// Shadow root that inherits only specific namespaces
// =============================================================================
class SelectiveCard extends HTMLElement {
  constructor() {
    super();

    // Inherit only 'input' namespace (visibility)
    // Output and memory use component defaults
    const shadow = this.attachShadow({
      mode: 'open',
      wamPolicyInherit: ['input'],  // Only inherit visibility policies
      wamProvenanceTransparent: false
    });

    shadow.innerHTML = `
      <style>
        :host {
          display: block;
          border: 2px solid #f39c12;
          border-radius: 8px;
          padding: 16px;
          margin: 16px 0;
        }
        .header { font-weight: bold; color: #f39c12; }
        .badge { background: #f39c12; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
      </style>

      <div class="header">
        <slot name="title"></slot>
        <span class="badge">Input Only</span>
      </div>

      <!--
        Inherits visibility from page, but mutation uses component default (readonly).
        LLM can see the content but cannot modify it.
      -->
      <div class="body" wam-policy-output="readonly">
        <slot name="content"></slot>
        <p>Visible to LLM but protected from modification.</p>
      </div>
    `;
  }
}
customElements.define('selective-card', SelectiveCard);

// =============================================================================
// Demonstrating the API
// =============================================================================
document.addEventListener('DOMContentLoaded', () => {

  // Get a component's shadow root
  const isolatedCard = document.querySelector('isolated-card');
  const shadow = isolatedCard.shadowRoot;

  // Check inheritance status
  console.log('Isolated card inherits:', shadow.wamPolicyInherits);
  console.log('Inherited namespaces:', shadow.llmInheritedNamespaces);
  console.log('Provenance transparent:', shadow.wamProvenanceTransparent);

  // Get effective policy for element inside shadow
  const internalDiv = shadow.querySelector('.body');
  const effectivePolicy = shadow.getEffectivePolicy(internalDiv);
  console.log('Effective output tokens:', effectivePolicy.effectiveOutputTokens);

  // Shadow provenance summary (aggregated when not transparent)
  const ledger = document.wamProvenanceLedger;
  const summary = ledger.getShadowSummary(shadow);
  if (summary) {
    console.log('Shadow mutations:', summary.totalMutations);
  }

  // Find all shadow roots with mutations
  const shadowRoots = ledger.getShadowRootsWithMutations();
  console.log('Shadow roots with mutations:', shadowRoots.length);

});
</script>

<!--
  SLOTTED CONTENT POLICIES
  Demonstrating how policies apply to slotted elements.
-->
<h2>Slotted Content Behavior</h2>

<slotted-demo>
  <!--
    This element has its own policy but is slotted into a component.
    The effective policy is the intersection of:
    1. The element's own policy
    2. The slot's context policy
    3. The inherited policy (if any)
  -->
  <p slot="content" wam-policy-output="content">
    I have my own policy but I'm being slotted.
  </p>
</slotted-demo>

<script>
class SlottedDemo extends HTMLElement {
  constructor() {
    super();
    const shadow = this.attachShadow({
      mode: 'open',
      wamPolicyInherit: true
    });

    shadow.innerHTML = `
      <style>
        :host { display: block; border: 1px solid #999; padding: 16px; margin: 16px 0; }
      </style>

      <!--
        The slot's context contributes to effective policy.
        If slot context is more restrictive, it wins.
      -->
      <div class="slot-wrapper" wam-policy-output="annotation">
        <slot name="content"></slot>
      </div>

      <p><small>
        Slotted element's effective policy = intersection of
        element policy (content) âˆ© slot context (annotation) = annotation only
      </small></p>
    `;
  }
}
customElements.define('slotted-demo', SlottedDemo);
</script>

</body>
</html>
